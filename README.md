# Engineered-Muscle-Contractility-Analysis-Pipeline-EMCAP-v1
Welcome to the Engineered Muscle Contractility Analysis Pipeline! (EMCAP) This suite of Python scripts is designed to batch process and analyze electrical stimulation data from engineered human muscle tissues from a time force 24 well data format. The core strength of this pipeline lies in its custom, in-house peak finding algorithms.

````markdown
# Muscle Kinetics Pipeline: Automated Analysis for 24-Well Engineered Tissues

**Version:** 1.0  
**License:** MIT License  

> **Need the full manual?** > [ðŸ“„ **Click here to view or download the complete User Guide (PDF)**](docs/README%20USER%20GUIDE.pdf)

---

## Citation
If you use this pipeline in your research, please cite the software as follows: TBA
---

## Table of Contents
1. [Introduction & Overview](#1-introduction--overview)
2. [Getting Started - System Setup](#2-getting-started---system-setup)
3. [Input Data Requirements](#3-input-data-requirements)
4. [Reference Protocol Settings](#4-reference-protocol-settings-json)
5. [Overview of Analysis Scripts](#5-overview-of-analysis-scripts--peak-detection-strategies)
6. [Running an Analysis](#6-running-an-analysis)
7. [Understanding the Outputs](#7-understanding-the-outputs)
8. [Post-Processing (Prism Merge)](#8-post-processing-with-prism-merge-scripts)
9. [Troubleshooting](#9-troubleshooting)

---

## 1. Introduction & Overview
Welcome to EMCAP, this suite of Python scripts is designed to batch process and analyze electrical stimulation data from engineered human muscle tissues in 24-well plate formats. 

* **Transparency:** Provides complete analytical visibility via open-source code and auto-generated calculation reference files.
* **Flexibility:** Deploys protocol-specific logic that automatically adapts peak detection strategies to match the distinct physiological profiles of 1Hz twitch, 75Hz tetanic, and Force-Frequency protocols.
* **Robustness:** **Signal Fidelity.** The pipeline rigorously separates true signal from noise using a 3-point validation rule to prevent false peaks. It also automatically corrects for baseline drift and includes safety checks (like "Fast Peak Warnings") to flag artifacts.

## 2. Getting Started - System Setup
To ensure the analysis scripts work correctly, you will use a pre-configured Python environment (`UW_environment.yml`).

### Prerequisites
* Anaconda or Miniconda installed.
* Data files (.xlsx or .csv).
* A plate map (.csv).

### Installation Steps
1.  **Install Anaconda:** Download and install Anaconda Individual Edition.
2.  **Create Environment:** Save the provided `UW_environment.yml` file, open your terminal/prompt, and run:
    ```bash
    conda env create -f UW_environment.yml
    conda activate UW
    ```
3.  **Launch Spyder:** Open Spyder from Anaconda Navigator. Verify the bottom-right console shows a path ending in `.../envs/UW/python.exe`.

## 3. Input Data Requirements
This pipeline is strictly designed for **Time vs. Force** data collected from **24-well plates**. It relies on specific file naming conventions and internal data structures.

### 3.1. Supported File Formats
The pipeline automatically detects and processes two standardized data layouts.

**Option A: Universal CSV (.csv) â€“ Recommended**

This format is generic and can be generated by most data acquisition hardware or manually created.
* **Structure:** A comma-separated file where the first column is Time, followed by one column per well.
* **Time Column:** Must be a single column named `Time (s)`.
* **Data Columns:** Must use standard well coordinates as headers (e.g., `A1`, `B1`, `C1`...).

**Option B: Formatted Excel (.xlsx)**
This option supports pre-formatted export files (such as those from the CuriBio PULSE 3D portal).
* **Sheet Requirement:** The file **MUST** contain a sheet named exactly: `continuous-waveforms`.
* **Column Naming:** * Time: `Time (seconds)`
    * Data: `[Well] - Active Twitch Force (Î¼N)` (e.g., `A1 - Active Twitch Force (Î¼N)`).

> **Technical Note:** The scripts automatically filter for wells **A1 through D6** (standard 24-well layout). Data columns for other well positions are ignored.

### 3.2. File Naming Convention (CRITICAL)
You **must** rename your input files to match this pattern so the script can sort data by Day, Plate, and Protocol.

**Format:** `[AnyText]__[Day]_[PlateName]_[Protocol].[extension]`

**Examples:**
* `Experiment1__d7_Plate1_Twitch.xlsx`
* `RawData__d28_WT_Fatigue.csv`

**Interpretation Logic:**
1.  Finds the token starting with `d` (e.g., `d7`).
2.  **Plate Name:** Text immediately following the Day.
3.  **Protocol:** Text immediately following the Plate Name.

## 4. Reference Protocol Settings (JSON)
Reference JSON files are included to replicate the specific stimulation timings (Delay, Duration, Frequency) used as defaults in these scripts. These parameters can be manually programmed into any stimulator.

* **Twitch (0.2Hz):** Default single-pulse protocol.
* **Fatigue:** Standard 4-block fatigue test with decreasing rest periods.
* **75Hz Tetanic:** Three trains of 75Hz stimulation (0.5s duration).
* **FF (Force-Frequency):** Stepped protocol ramping from 1Hz to 100Hz.

## 5. Overview of Analysis Scripts & Peak Detection Strategies

### 5.1 Twitch Analysis
* **Purpose:** Detailed kinetics of individual twitches, baseline drift, and fatigue metrics.
* **Logic:** Searches for peak **after T0** (Stimulation Start).
* **Metrics:** Calculates time to peak (TTP) and relaxation times (R50, R90) relative to the baseline.

![Diagram of single muscle twitch showing T0, Peak, and Relaxation phases](images/twitch_kinetics_diagram.png)

### 5.2 Fatigue Analysis
* **Purpose:** Tracks force decline across 4 distinct blocks and calculates Fatigue Resistance Index (FRI).
* **Logic:** Identifies the peak for every stimulation to track the "envelope" of force decline over time.

![Graph showing muscle fatigue force decline over time](images/fatigue_drop_graph.png)

### 5.3 Continuous (75Hz) Analysis
* **Purpose:** Tetanic contractions.
* **Logic (Dual Approach):** 1. **Kinetics Peak:** Searches near T1 (Stim End) for relaxation timing.
    2. **Max Tetanic Force:** Searches T0 to T1+200ms for absolute strength.

![Graph of fused tetanic contraction showing plateau](images/tetanic_contraction.png)

### 5.4 Force-Frequency (FvF) Analysis
* **Purpose:** Force-vs-Frequency relationships.
* **Logic:** Uses the Dual Approach to capture the step-wise increase in force as frequency increases.

![Graph of Force-Frequency Relationship curve](images/force_frequency_curve.png)

## 6. Running an Analysis
1.  Open the appropriate Python script in Spyder.
2.  **Check Configuration:** Edit the top section (CONFIGURATION SECTION) if your timings differ from defaults.
3.  **Run (F5).**
4.  **Select Input Files:** A dialog will open. You can select multiple `.xlsx` or `.csv` files.
5.  **Select Plate Map:** A second dialog will open for your `.csv` layout.
6.  **Select Output Directory.**

## 7. Understanding the Outputs
Each script generates an Excel file containing:
* **Summary Sheet:** Row-by-row metrics for every stimulation.
* **Condition Sheets:** Full time-course data per condition.
* **Representative Traces:** Averaged waveform shapes.
* **Calculation Reference (.md):** A text file detailing the exact math used for that run.

## 8. Post-Processing with Prism Merge Scripts
Use these scripts to combine daily analysis files into pivoted tables ready for GraphPad Prism.

* **Twitch Merge:** Creates `Twitch_Final_Tables.xlsx`. Prioritizes individual force data.
* **Fatigue Prism Merge:** Extracts FRI, TimeAt75, and ForceAtStim metrics.
* **75Hz Prism Merge:** Creates pivoted tables for relaxation kinetics.
* **Force Frequency Prism Merge:** Creates XY tables for F-F curves and Grouped tables for Max Capacity.

## 9. Troubleshooting
* **ModuleNotFoundError:** Ensure your `UW` environment is activated.
* **File Not Found/Parsed:** Check your filename format! It must include `__d[X]_[Plate]_[Protocol]`.
* **CSV Not Showing:** Ensure "Data files" or "All files" is selected in the file dialog dropdown.

---

**Contact & Support**
If you encounter problems, please open an Issue on this GitHub repository.
````
